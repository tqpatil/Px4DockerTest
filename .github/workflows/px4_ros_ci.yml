name: px4 ros integration ci

on:
  push:
  pull_request:

jobs:
  px4-ros:
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/sloretz/ros:humble-desktop-full

    steps:
      - name: checkout repo
        uses: actions/checkout@v4

      - name: install dependencies
        run: |
          set -e
          apt-get update
          apt-get install -y \
            git \
            python3-pip \
            python-is-python3 \
            build-essential \
            cmake \
            ninja-build \
            protobuf-compiler \
            libeigen3-dev \
            libopencv-dev \
            wget \
            lsb-release \
            gnupg \
            sudo \
            curl \
            vim \
            gdb \
            valgrind \
            astyle \
            lcov \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav \
            rsync

          pip3 install --no-cache-dir --upgrade pip
          pip3 install --no-cache-dir \
            kconfiglib \
            empy==3.3.4 \
            pyros-genmsg \
            jinja2 \
            packaging \
            jsonschema \
            future \
            pyyaml \
            pyserial \
            toml \
            numpy \
            pandas

      - name: install gazebo garden
        run: |
          set -e
          wget https://packages.osrfoundation.org/gazebo.gpg -O /usr/share/keyrings/pkgs-osrf-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/pkgs-osrf-archive-keyring.gpg] \
            http://packages.osrfoundation.org/gazebo/ubuntu-stable $(lsb_release -cs) main" \
            | tee /etc/apt/sources.list.d/gazebo-stable.list > /dev/null
          apt-get update
          apt-get install -y gz-garden

      - name: install micro xrce dds agent
        run: |
          set -e
          cd /tmp
          git clone https://github.com/eProsima/Micro-XRCE-DDS-Agent.git
          cd Micro-XRCE-DDS-Agent
          mkdir build && cd build
          cmake ..
          make -j$(nproc)
          make install
          ldconfig
          cd / && rm -rf /tmp/Micro-XRCE-DDS-Agent

      - name: prepare workspace
        run: |
          set -e
          WORKSPACE=$HOME/workspace
          PX4_DIR=$WORKSPACE/PX4-Autopilot
          ROS_WS=$WORKSPACE/ros2_ws

          mkdir -p $WORKSPACE
          cd $WORKSPACE

          if [ ! -d "$PX4_DIR" ]; then
            git clone -b release/1.14 https://github.com/PX4/PX4-Autopilot.git --recursive
          fi

          mkdir -p $ROS_WS/src
          cd $ROS_WS/src

          if [ ! -d "px4_msgs" ]; then
            git clone -b release/1.14 https://github.com/PX4/px4_msgs.git
          fi

          if [ ! -d "px4_ros_com" ]; then
            git clone -b release/v1.14 https://github.com/PX4/px4_ros_com.git
          fi

          mkdir -p $HOME/scripts

          cat > $HOME/scripts/build_px4.sh << 'EOF'
          #!/bin/bash
          set -e

          export PX4_SIM_SPEED_FACTOR=2
          export PX4_GZ_MODEL=x500
          export GZ_SIM_RESOURCE_PATH=$HOME/workspace/PX4-Autopilot/Tools/simulation/gz/models
          export GZ_SIM_SYSTEM_PLUGIN_PATH=$HOME/workspace/PX4-Autopilot/build/px4_sitl_default/build_gz-garden
          cd $HOME/workspace/PX4-Autopilot
          make distclean
          EOF
          chmod +x $HOME/scripts/build_px4.sh

          cat > $HOME/scripts/build_ros2.sh << 'EOF'
          #!/bin/bash
          set -e
          source /opt/ros/humble/setup.bash
          cd $HOME/workspace/ros2_ws
          colcon build --symlink-install
          source install/setup.bash
          EOF
          chmod +x $HOME/scripts/build_ros2.sh

          cat > $HOME/scripts/run_dds_agent.sh << 'EOF'
          #!/bin/bash
          set -e

          LOG=$HOME/logs/microxrce_agent.log
          mkdir -p "$(dirname "$LOG")"

          nohup MicroXRCEAgent udp4 -p 8888 > "$LOG" 2>&1 &
          PID=$!
          echo $PID > $HOME/.microxrce_agent.pid

          for i in $(seq 1 30); do
            if kill -0 "$PID" >/dev/null 2>&1 || pgrep -f MicroXRCEAgent >/dev/null; then
              echo "MicroXRCEAgent started (pid $PID)"
              exit 0
            fi
            sleep 1
          done

          echo "MicroXRCEAgent failed to start; last 200 lines of log:" >&2
          tail -n 200 "$LOG" >&2
          exit 1
          EOF
          chmod +x $HOME/scripts/run_dds_agent.sh

          cat > $HOME/scripts/run_simulation.sh << 'EOF'
          #!/bin/bash
          set -e

          LOG=$HOME/logs/px4_gz.log
          mkdir -p "$(dirname "$LOG")"

          for i in $(seq 1 120); do
            if pgrep -f MicroXRCEAgent >/dev/null || [ -f "$HOME/.microxrce_agent.pid" ]; then
              echo "MicroXRCEAgent is running, proceeding"
              break
            fi
            echo "Waiting for MicroXRCEAgent to be ready..."
            sleep 1
          done

          export PX4_SIM_SPEED_FACTOR=2
          export PX4_GZ_MODEL=x500
          export PX4_UXRCE_DDS_NS=fmu
          export PX4_UXRCE_DDS_PORT=8888
          export GZ_SIM_RESOURCE_PATH=$HOME/workspace/PX4-Autopilot/Tools/simulation/gz/models
          export GZ_SIM_SYSTEM_PLUGIN_PATH=$HOME/workspace/PX4-Autopilot/build/px4_sitl_default/build_gz-garden
          export HEADLESS=1
          cd $HOME/workspace/PX4-Autopilot
          make distclean

          HEADLESS=1 make px4_sitl gz_x500 > "$LOG" 2>&1 &
          PX4_PID=$!
          echo $PX4_PID > /tmp/px4_pid.txt

          for i in $(seq 1 60); do
            if [ -e /tmp/px4_pid.txt ] && kill -0 "$PX4_PID" >/dev/null 2>&1; then
              echo "PX4 started (pid $PX4_PID)"
              break
            fi
            sleep 1
          done
          EOF
          chmod +x $HOME/scripts/run_simulation.sh

      - name: build px4
        run: |
          $HOME/scripts/build_px4.sh

      - name: build ros
        run: |
          $HOME/scripts/build_ros2.sh

      - name: start dds and px4
        run: |
          set -e

          # Start DDS agent
          echo "Starting MicroXRCE-DDS Agent..."
          $HOME/scripts/run_dds_agent.sh

          # Start PX4 simulation
          echo "Starting PX4 SITL simulation..."
          $HOME/scripts/run_simulation.sh

          # Give PX4 time to boot up and start publishing
          echo "Waiting for PX4 to initialize..."
          sleep 10

      - name: test ros topics
        shell: bash
        run: |
          source /opt/ros/humble/setup.bash
          source $HOME/workspace/ros2_ws/install/setup.bash

          # Verify processes are still running
          if ! kill -0 $(cat $HOME/.microxrce_agent.pid) 2>/dev/null; then
            echo "ERROR: DDS agent is not running"
            echo "=== DDS Agent Log ==="
            cat $HOME/logs/microxrce_agent.log
            exit 1
          fi

          if ! kill -0 $(cat /tmp/px4_pid.txt) 2>/dev/null; then
            echo "ERROR: PX4 simulation is not running"
            echo "=== PX4 Simulation Log ==="
            tail -n 100 $HOME/logs/px4_gz.log
            exit 1
          fi

          echo "Both processes are running, waiting for ROS topics..."

          # Wait up to 90 seconds for the topic to appear
          if ! timeout 90 bash -c '
            while ! ros2 topic list | grep -q /fmu/fmu/out/sensor_combined; do
              echo "Waiting for topic /fmu/fmu/out/sensor_combined... ($(date +%H:%M:%S))"
              sleep 5
            done
          '; then
            echo "ERROR: Timeout waiting for /fmu/fmu/out/sensor_combined topic"
            echo ""
            echo "=== Available ROS 2 Topics ==="
            ros2 topic list || true
            echo ""
            echo "=== Last 100 lines of PX4 Log ==="
            tail -n 100 $HOME/logs/px4_gz.log
            echo ""
            echo "=== Last 50 lines of DDS Agent Log ==="
            tail -n 50 $HOME/logs/microxrce_agent.log
            exit 1
          fi

          echo "Topic found! Listing all available topics:"
          ros2 topic list

          echo ""
          echo "Reading from /fmu/fmu/out/sensor_combined:"
          ros2 topic echo /fmu/fmu/out/sensor_combined --once

      - name: stop px4 and dds
        if: always()
        run: |
          echo "Stopping PX4 and DDS agent..."
          if [ -f /tmp/px4_pid.txt ]; then
            kill $(cat /tmp/px4_pid.txt) 2>/dev/null || echo "PX4 process already stopped"
          fi
          if [ -f $HOME/.microxrce_agent.pid ]; then
            kill $(cat $HOME/.microxrce_agent.pid) 2>/dev/null || echo "DDS agent process already stopped"
          fi

          echo "--- Last PX4 logs ---"
          tail -n 200 $HOME/logs/px4_gz.log || true
          echo "--- Last DDS logs ---"
          tail -n 200 $HOME/logs/microxrce_agent.log || true

      - name: upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: simulation-logs
          path: |
            $HOME/logs/px4_gz.log
            $HOME/logs/microxrce_agent.log
          retention-days: 5
